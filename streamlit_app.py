import streamlit as st
import google.generativeai as genai
import json

# --- إعداد الصفحة ---
st.set_page_config(
    page_title="منصة مُسند",
        layout="centered",
            initial_sidebar_state="collapsed"
            )

            # --- إعداد مفتاح الذكاء الاصطناعي ---
            # تم وضع مفتاحك هنا
            genai.configure(api_key="AIzaSyAJh5umqetqUtTEZxqpCa7vs-0EMZfIhi4")

            # --- التنسيق (CSS) ---
            st.markdown("""
                <style>
                    /* الاتجاه من اليمين لليسار */
                        .stApp {
                                direction: rtl;
                                        text-align: right;
                                            }
                                                /* تنسيق الهيدر */
                                                    .header-container {
                                                            background-color: #2b57bf;
                                                                    padding: 2rem;
                                                                            border-radius: 10px;
                                                                                    text-align: center;
                                                                                            color: white;
                                                                                                    margin-bottom: 2rem;
                                                                                                        }
                                                                                                            .header-title {
                                                                                                                    font-family: sans-serif;
                                                                                                                            font-size: 3rem;
                                                                                                                                    font-weight: bold;
                                                                                                                                            margin: 0;
                                                                                                                                                }
                                                                                                                                                    .header-subtitle {
                                                                                                                                                            font-size: 1.2rem;
                                                                                                                                                                    opacity: 0.9;
                                                                                                                                                                        }
                                                                                                                                                                            /* إخفاء القوائم */
                                                                                                                                                                                #MainMenu {visibility: hidden;}
                                                                                                                                                                                    footer {visibility: hidden;}
                                                                                                                                                                                        
                                                                                                                                                                                            /* تنسيق بطاقات النتائج */
                                                                                                                                                                                                .result-card {
                                                                                                                                                                                                        background-color: #f0f2f6;
                                                                                                                                                                                                                padding: 1.5rem;
                                                                                                                                                                                                                        border-radius: 10px;
                                                                                                                                                                                                                                margin-bottom: 1rem;
                                                                                                                                                                                                                                        border-right: 5px solid #2b57bf;
                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                .verdict-box {
                                                                                                                                                                                                                                                        font-size: 1.5rem;
                                                                                                                                                                                                                                                                font-weight: bold;
                                                                                                                                                                                                                                                                        padding: 1rem;
                                                                                                                                                                                                                                                                                border-radius: 5px;
                                                                                                                                                                                                                                                                                        text-align: center;
                                                                                                                                                                                                                                                                                                margin-bottom: 1rem;
                                                                                                                                                                                                                                                                                                        color: white;
                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                </style>
                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                        <div class="header-container">
                                                                                                                                                                                                                                                                                                                                <div class="header-title">MUSNAD</div>
                                                                                                                                                                                                                                                                                                                                        <div class="header-subtitle">نسند المعلومة لأصلها</div>
                                                                                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                                                                                                """, unsafe_allow_html=True)

                                                                                                                                                                                                                                                                                                                                                # --- البرومبت (الأوامر) كما في الملف الأصلي تماماً ---
                                                                                                                                                                                                                                                                                                                                                analysis_prompt = """
                                                                                                                                                                                                                                                                                                                                                أنت "مُسند"، باحث وخبير متخصص في تدقيق المعلومات وتحليل الأخبار. مهمتك هي تحليل النص التالي الذي يزودك به المستخدم.

                                                                                                                                                                                                                                                                                                                                                يجب عليك اتباع الخطوات التالية بدقة وإخراج النتيجة بصيغة JSON بناءً على المخطط المحدد. **مهم جداً: يجب أن يكون ردك عبارة عن كائن JSON صالح فقط، بدون أي نص إضافي أو علامات markdown مثل ```json.**

                                                                                                                                                                                                                                                                                                                                                المخطط المطلوب:
                                                                                                                                                                                                                                                                                                                                                {
                                                                                                                                                                                                                                                                                                                                                  "originalArticle": "string",
                                                                                                                                                                                                                                                                                                                                                    "contextualAnalysis": {
                                                                                                                                                                                                                                                                                                                                                        "summary": "string",
                                                                                                                                                                                                                                                                                                                                                            "perspectives": "string",
                                                                                                                                                                                                                                                                                                                                                                "relatedContext": "string"
                                                                                                                                                                                                                                                                                                                                                                  },
                                                                                                                                                                                                                                                                                                                                                                    "factCheck": {
                                                                                                                                                                                                                                                                                                                                                                        "verdict": "string",
                                                                                                                                                                                                                                                                                                                                                                            "summary": "string",
                                                                                                                                                                                                                                                                                                                                                                                "details": "string"
                                                                                                                                                                                                                                                                                                                                                                                  },
                                                                                                                                                                                                                                                                                                                                                                                    "sentimentAndBiasAnalysis": {
                                                                                                                                                                                                                                                                                                                                                                                        "sentiment": "string",
                                                                                                                                                                                                                                                                                                                                                                                            "bias": "string"
                                                                                                                                                                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                                                                                                                                                                              }

                                                                                                                                                                                                                                                                                                                                                                                              الخطوات:
                                                                                                                                                                                                                                                                                                                                                                                              1.  **إعادة عرض المقال (originalArticle):** قم بإعادة نص المقال الأصلي كما هو بدون أي تغيير.

                                                                                                                                                                                                                                                                                                                                                                                              2.  **التحليل السياقي (contextualAnalysis):** قدم تحليلًا عميقًا للمقال في صورة كائن. غطِّ النقاط التالية:
                                                                                                                                                                                                                                                                                                                                                                                                  * **summary:** لخص النقاط الرئيسية في الخبر بشكل موجز وواضح.
                                                                                                                                                                                                                                                                                                                                                                                                      * **perspectives:** حدد الآراء والمواقف المختلفة المذكورة في الخبر أو المتعلقة به، مع توضيح من يمثل كل موقف إن أمكن. إذا كان الخبر يعرض وجهة نظر واحدة، اذكر ذلك.
                                                                                                                                                                                                                                                                                                                                                                                                          * **relatedContext:** اربط الخبر بأحداث أو أخبار سابقة ذات صلة. استخدم بحث جوجل للعثور على سياق إضافي أو تطورات سابقة للموضوع لتقديم صورة كاملة.

                                                                                                                                                                                                                                                                                                                                                                                                          3.  **التحقق من الادعاء (factCheck):**
                                                                                                                                                                                                                                                                                                                                                                                                              * حدد الادعاء الرئيسي أو الادعاءات الأكثر أهمية في الخبر.
                                                                                                                                                                                                                                                                                                                                                                                                                  * استخدم بحث جوجل للتحقق من صحة هذه الادعاءات.
                                                                                                                                                                                                                                                                                                                                                                                                                      * قدم حكمًا واضحًا (verdict) على الادعاء (مثال: "صحيح"، "مضلل"، "زائف"، "غير قابل للتحقق").
                                                                                                                                                                                                                                                                                                                                                                                                                          * اكتب ملخصًا (summary) للنتيجة بنفس الأسلوب الموجود في المثال الإرشادي.
                                                                                                                                                                                                                                                                                                                                                                                                                              * قدم شرحًا مفصلاً (details) لعملية التحقق، مع ذكر المصادر والأدلة التي وجدتها، ونسق الشرح بطريقة واضحة ومقروءة باستخدام فقرات وعناوين فرعية إذا لزم الأمر.

                                                                                                                                                                                                                                                                                                                                                                                                                              4.  **تحليل المشاعر والانحياز (sentimentAndBiasAnalysis):**
                                                                                                                                                                                                                                                                                                                                                                                                                                  * **sentiment:** حدد المشاعر العامة في النص (إيجابية، سلبية، محايدة) واذكر أي نبرة عاطفية مهيمنة.
                                                                                                                                                                                                                                                                                                                                                                                                                                      * **bias:** حلل النص لتحديد أي انحياز محتمل (سياسي، إيديولوجي، انحياز التأطير، إلخ). قدم شرحًا موجزًا لأي انحياز تم رصده.

                                                                                                                                                                                                                                                                                                                                                                                                                                      الآن، قم بتحليل المقال التالي:
                                                                                                                                                                                                                                                                                                                                                                                                                                      """

                                                                                                                                                                                                                                                                                                                                                                                                                                      # --- واجهة المستخدم والمنطق ---
                                                                                                                                                                                                                                                                                                                                                                                                                                      st.markdown("### أدخل نص الخبر هنا للتحليل")
                                                                                                                                                                                                                                                                                                                                                                                                                                      user_input = st.text_area("", height=150, placeholder="ألصق النص هنا...")

                                                                                                                                                                                                                                                                                                                                                                                                                                      if st.button("تحليل الخبر", type="primary", use_container_width=True):
                                                                                                                                                                                                                                                                                                                                                                                                                                          if not user_input:
                                                                                                                                                                                                                                                                                                                                                                                                                                                  st.warning("الرجاء إدخال نص للتحليل")
                                                                                                                                                                                                                                                                                                                                                                                                                                                      else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                              with st.spinner('جاري تحليل المصداقية والبحث في المصادر (مُسند)...'):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                          try:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          # إعداد الموديل مع تفعيل أدوات البحث وجعل الإخراج JSON
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          # نستخدم gemini-1.5-pro لأنه الأفضل في اتباع التعليمات المعقدة والبحث
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          model = genai.GenerativeModel(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              'gemini-1.5-pro',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  tools='google_search_retrieval'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  full_prompt = f"{analysis_prompt}\n\n{user_input}"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  # إرسال الطلب
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  response = model.generate_content(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      full_prompt,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          generation_config={"response_mime_type": "application/json"}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          # معالجة النتيجة (JSON Parsing)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          try:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              data = json.loads(response.text)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      # --- عرض النتائج بتصميم جميل ---
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              # 1. الحكم النهائي (ملون)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  verdict = data['factCheck']['verdict']
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      color = "#2b57bf" # أزرق افتراضي
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          if "زائف" in verdict or "مضلل" in verdict:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  color = "#d9534f" # أحمر
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      elif "صحيح" in verdict:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              color = "#5cb85c" # أخضر
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  elif "غير دقيق" in verdict:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          color = "#f0ad4e" # برتقالي
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      st.markdown(f"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <div class="verdict-box" style="background-color: {color};">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      الحكم: {verdict}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  """, unsafe_allow_html=True)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          # 2. تفاصيل التحقق
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              st.subheader("📋 نتيجة التحقق")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  st.info(data['factCheck']['summary'])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      with st.expander("عرض تفاصيل الأدلة والتحقق", expanded=True):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              st.markdown(data['factCheck']['details'])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      # 3. التحليل السياقي
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          st.markdown("---")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              col1, col2 = st.columns(2)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  with col1:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          st.subheader("🔍 ملخص الخبر")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  st.markdown(f"<div class='result-card'>{data['contextualAnalysis']['summary']}</div>", unsafe_allow_html=True)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      with col2:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              st.subheader("⚖️ الانحياز والمشاعر")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      st.markdown(f"""
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <div class='result-card'>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <b>المشاعر:</b> {data['sentimentAndBiasAnalysis']['sentiment']}<br>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <b>الانحياز:</b> {data['sentimentAndBiasAnalysis']['bias']}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              """, unsafe_allow_html=True)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  # 4. وجهات النظر والسياق
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      st.subheader("🌍 سياق إضافي ووجهات نظر")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          st.markdown(f"**وجهات النظر:** {data['contextualAnalysis']['perspectives']}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              st.markdown(f"**سياق ذو صلة:** {data['contextualAnalysis']['relatedContext']}")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              except json.JSONDecodeError:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  # في حال لم يرسل الموديل JSON نظيف (نادر الحدوث مع الإعدادات الحالية)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      st.error("حدث خطأ في تنسيق البيانات، إليك الرد الخام:")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          st.markdown(response.text)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      st.error(f"حدث خطأ أثناء الاتصال: {e}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
